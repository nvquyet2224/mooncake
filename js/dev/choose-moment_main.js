var isNext=0,isRenderVideo=!1,videoLink="https://storage.googleapis.com/prod-reflect-videos/data/inputs/a30cd3af-cbc4-463a-9bd2-4efd1bc4ce62.mp4",blankImg="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",showMashCount=0,facesArr=[{avatar:"images/face1.png"},{avatar:"images/face2.png"},{avatar:"images/face3.png"}];function addFaceToList(){for(var e="",o=0;o<facesArr.length;o++)e+=`<div class="face-item">\n                    <div class="pic avatar">\n                        <img src="${facesArr[o].avatar}" alt="face">\n                    </div>\n                    <div class="pic delete-but">\n                        <img src="images/icon-delete.svg" alt="delete">\n                    </div>\n            </div>`;$(".face-list").append(e)}var faceMapArr=[];function getFaceMap(){faceMapArr=[],$(".personage").each((function(){$(this).hasClass("done")?faceMapArr.push({map:!0,imgMap:$(this).find(".face img").attr("src")}):faceMapArr.push({map:!1,imgMap:""})})),console.log(faceMapArr)}const queryString=window.location.search,urlParams=new URLSearchParams(queryString);function preventDefaults(e){e.preventDefault()}var cropImg,imgData,interRactive=!1;function hideAllVideo(){[].slice.call(document.querySelectorAll(".choose-item-video video")).forEach((function(e){e.currentTime>0&&!e.paused&&e.pause()}))}function hideOrtherVideo(e){$(".choose-item-video").hasClass("active")&&[].slice.call(document.querySelectorAll(".choose-item-video video")).forEach((function(o){o!==e?o.currentTime>0&&!o.paused&&o.pause():e.currentTime>0&&!e.paused||(e.play(),interRactive&&(e.muted=!1))}))}function CountUp(e,o,a){var t=o-e,i=e,n=Math.abs(Math.floor(a/t)),s=setInterval((function(){(i+=1)<=o?($(".bg-value").css({width:i+"%"}),$(".percent-value").html(i)):clearInterval(s)}),n)}function uploadFile(e){$(".choose-item-upload").addClass("uploaded");var o=e.type.split("/")[1];if(!(["jpg","jpeg","png"].indexOf(o)<0)){var a=new FileReader;a.onload=function(e){var o=e.target.result;imgData=o,document.querySelector(".upload__block").classList.add("show__crop"),cropImg.croppie("bind",{url:imgData}).then((function(){cropImg.croppie("setZoom",2)}))},a.readAsDataURL(e)}}function processFiles(e){e&&e.length?uploadFile(e[0]):console.log("false")}function handleDrag(e){e.stopPropagation(),e.preventDefault()}function handleDrop(e){e.stopPropagation(),e.preventDefault(),processFiles(e.dataTransfer.files)}$(".choose-item-video video").mouseenter((function(){hideOrtherVideo(this)})),$(document).on("click",(function(){interRactive=!0})),fileImage.onchange=function(e){processFiles(e.target.files)},["dragenter","dragover"].forEach((function(e){uploadArea.addEventListener(e,handleDrag,!1)})),["dragleave","drop"].forEach((function(e){uploadArea.addEventListener(e,handleDrop,!1)})),function(){const e=Lib.modules,o=new e.Common,a=e.Swiper;o.init(),document.querySelector(".hero__slider")&&new a(".hero__slider",{effect:"slide",loop:!1,speed:1e3,disableOnInteraction:!0,pauseOnMouseEnter:!0,slidesPerView:1.2,spaceBetween:10,watchOverflow:!0,on:{init:function(){$(".choose-item-video").hasClass("active")&&hideOrtherVideo(this.slides[this.activeIndex].querySelector("video"))},slideChange:function(){console.log("slideChange")},transitionStart:function(){$(".choose-item-video").hasClass("active")&&hideOrtherVideo(this.slides[this.activeIndex].querySelector("video"))},transitionEnd:function(){console.log("end")},resize:function(){}},breakpoints:{810:{slidesPerView:4,spaceBetween:30}},navigation:{nextEl:".choose-section .swiper-button-next",prevEl:".choose-section .swiper-button-prev"},pagination:{el:".choose-section .swiper-pagination",clickable:!0}}).update(),$(".slide-item").on("click",(function(){$(".slide-item.selected").removeClass("selected"),$(this).addClass("selected"),videoLink=$(this).attr("data-vid"),interRactive=!0,this.querySelector("video").muted=!1,videoMoment.src=videoLink})),$("#gotoUpload").on("click",(function(){$(".choose-item-video").removeClass("active"),$(".choose-item-upload").addClass("active"),hideAllVideo()})),$("#btnCapImg, #btnUploadImgSP").on("click",(function(){fileImage.click()}));var t="personage1",i="";$(".personage").on("click",(function(){t=$(this).attr("data-personage"),i=$(this).find(".avatar img").attr("src"),$(".personage:not(.done) .avatar").removeClass("active"),$(".personage[data-personage="+t+"]").hasClass("done")||($(".personage[data-personage="+t+"] .avatar").addClass("active"),$(".faces").attr("data-face",t)),$(".original img").attr("src",i),$(".original").attr("data-personage",t)})),$(document).on("click",".face-item .avatar",(function(){var e=$(this).find("img").attr("src");$(".personage[data-personage="+t+"] .face img").attr("src",e),$(".personage[data-personage="+t+"]").addClass("done"),$(".personage[data-personage="+t+"] .avatar").addClass("active")})),$(".original").on("click",(function(){var e=$(this).attr("data-personage");$(".personage[data-personage="+e+"]").removeClass("done"),$(".personage[data-personage="+e+"] .face img").attr("src",blankImg)})),$(document).on("click",".face-item .delete-but",(function(){var e=$(this).parent().find(".avatar img").attr("src");$(".personage.done").each((function(){var o=$(this).find(".face img").attr("src");e===o&&($(this).removeClass("done"),$(this).find(".avatar").removeClass("active"))})),$(this).parent().remove()})),$(".add-face").on("click",(function(){$(".more__backdrop").addClass("active"),fileImage.value="",$(".crop__box .cr-boundary img").attr("src",blankImg)})),$(".close-moreface").on("click",(function(){$(".more__backdrop").removeClass("active")})),$(".cap_now, .upload_now").on("click",(function(){$(".more__backdrop").removeClass("active"),$(".choose-item-moment").removeClass("active"),$(".choose-item-upload").addClass("active"),videoMoment.currentTime>0&&!videoMoment.paused&&videoMoment.pause()})),$("#backtoMoment").on("click",(function(){isRenderVideo||($(".choose-item-sticker").removeClass("active"),$(".choose-item-moment").addClass("active")),videoMoment.play(),videoMoment.muted=!1})),cropImg=$("#cropImg").croppie({viewport:{width:"100%",height:"100%"},minZoom:1,initialZoom:1.5,maxZoom:6}),$(document).on("click",".popup-close",(function(){o.closePopup(),isNext||(document.querySelector(".upload__block").classList.remove("show__crop"),$("#fileImage").val(""))})),$(document).on("click",".but-close-popup",(function(){o.closePopup()})),$("#btnUploadImg").on("click",(function(){$(".loading__box").hasClass("active")||$(".loading__box").addClass("active"),setTimeout((function(){!function(){$(".real__download").html("");var e=$(".real__download"),a=$(".result_img").width(),t=$(".result_img").height(),i=600/a;console.log(i);var n=$(".result_img").clone().css({width:a*i,height:t*i}).appendTo(e),s=$(n).find(".cr-image"),c=$(s).css("opacity"),r=$(s).css("transform"),l=$(s).css("transform-origin"),d=(l=l.split(" "))[0].split("px")[0]*i,m=l[1].split("px")[0]*i,p=r.split("(")[1],u=(p=(p=p.split(")")[0]).split(","))[0],v=p[1],h=Math.sqrt(u*u+v*v),f=`\n    opacity: ${c}; transform: translate3d(${p[4]*i}px, ${p[5]*i}px, 0px) scale(${h});transform-origin: ${d}px ${m}px;\n  `;s.attr("style",f),e.css({width:a*i,height:t*i}),html2canvas(document.querySelector(".real__download"),{scale:1}).then((function(e){setTimeout((function(){var a=e.toDataURL("image/jpg");console.log(a),isNext=Math.floor(2*Math.random()),isNext=1,document.querySelector(".upload__block").classList.remove("loading"),$(".choose-item-upload").removeClass("uploaded"),$(".upload__block").removeClass("show__crop"),0===isNext?o.openPopup("#popupFaceDetect"):($(".choose-item-upload").removeClass("active"),$(".choose-item-moment").addClass("active"),0===showMashCount?($("body").addClass("show-mask"),showMashCount++):(addFaceToList(),videoMoment.play(),videoMoment.muted=!1),$(".choose-item-upload").removeClass("active"),$(".choose-item-moment").addClass("active"),$("body").addClass("show-mask"),$(".loading__box").hasClass("active")&&$(".loading__box").removeClass("active"))}),100)}))}()}),100)})),$(".close-mask, .cancel-tooltip, .next-tooltip__done").on("click",(function(){$("body").removeClass("show-mask"),$("body").removeClass("show-mask2"),videoMoment.play(),videoMoment.muted=!1})),$(".next-tooltip__go").on("click",(function(){$("body").addClass("show-mask2")})),$("#btnCreateVideo").on("click",(function(){isRenderVideo=!1,videoMoment.currentTime>0&&!videoMoment.paused&&videoMoment.pause(),o.openPopup("#popupProgressVideo"),CountUp(1,90,1e4),getFaceMap(),setTimeout((function(){CountUp(91,100,1e3),$(".choose-item-moment").removeClass("active"),$(".choose-item-sticker").addClass("active"),function(){var e=new fabric.Canvas("cavanRender"),a=document.getElementById("videoRender");a.src=videoLink;var t,i=$("#videoBoxRender").innerWidth(),n=110*i/100,s=new fabric.Image(a,{left:0,top:0,scaleX:i/1080,scaleY:n/1080});e.setDimensions({width:i,height:n}),e.add(s),a.load(),e.item(0).selectable=!1,$(".sticker-item").on("click",(function(){if(!isRenderVideo){$(".sticker-item").removeClass("active"),$(this).addClass("active");var o=$(this).find("img").attr("src");e.item(1)&&e.remove(e.item(1)),fabric.Image.fromURL(o,(function(o){e.add(o.set({left:100,top:50}))}))}})),window.cancelRequestAnimFrame=window.cancelAnimationFrame||window.webkitCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||clearTimeout;var c=function(){e.renderAll(),t=fabric.util.requestAnimFrame(c)};$("#gotoShare").on("click",(function(){if(isRenderVideo=!0,e.discardActiveObject().renderAll(),e.item(1)){e.item(1).selectable=!1;var i=e.item(1),n={angle:i.angle,left:i.left,top:i.top,width:i.width,scaleX:i.scaleX,scaleY:i.scaleY};console.log(n)}a.play(),a.muted=!1,fabric.util.requestAnimFrame(c),a.onended=function(){cancelRequestAnimFrame(t);var e,a,i,n=document.querySelector("#videoResult");n.style.display="block",n.src=videoLink,e=videoLink,a="videome",(i=document.querySelector(".download-box")).setAttribute("href",e),i.setAttribute("download",a),$(".choose-item-sticker").removeClass("active"),$(".choose-item-share").addClass("active"),o.openPopup(".is__mention"),n.play(),n.muted=!1}})),fabric.util.requestAnimFrame(c)}(),o.closePopup()}),15e3)})),$(document).on("click",".show__condition",(function(){o.openPopup(".popup__condition")})),$(document).on("click",".popup-close",(function(){o.closePopup()})),$(document).on("click","#btnUploadBack",(function(){fileImage.value="",fileImage.click()})),$(".choose-item-moment video").on("click",(function(){this.currentTime>0&&!this.paused?this.pause():(this.play(),this.muted=!1,interRactive=!0)})),$(document).on("click",".coseShare",(function(){o.closePopup();var e=$(".share-right").offset().top;$("html, body").animate({scrollTop:e},500)}))}();